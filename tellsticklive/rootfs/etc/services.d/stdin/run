#!/command/with-contenv bashio
# ==============================================================================
# Starts the STDIN service
# ==============================================================================

bashio::log.info 'Starting the Home Assistant STDIN service...'

# shellcheck disable=SC2162
while true; do
    if ! read -r input < /proc/1/fd/0; then
        # read failed (EOF or error), wait before retrying to avoid tight loop
        sleep 1
        continue
    fi

    # Skip empty input
    if [[ -z "${input}" ]]; then
        continue
    fi

    # parse JSON value
    funct=$(bashio::jq "${input}" '.function')
    devid=$(bashio::jq "${input}" '.device // empty')
    bashio::log.info "Read ${funct} / ${devid}"

    if ! msg="$(tdtool "--${funct}" "${devid}")"; then
        bashio::log.error "TellStick ${funct} fails -> ${msg}"
    else
        bashio::log.info "TellStick ${funct} success -> ${msg}"
    fi
done
